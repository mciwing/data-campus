
## Übung ✍️

Nun üben wir wieder an unserem bestehenden Projekt. Die **TecGuy GmbH** baut ihr Produktionsplanungssystem weiter aus und benötigt eine Verwaltung für ihre Produktionsmaschinen.

In dieser Übung wenden wir **alle Konzepte** aus diesem Kapitel an: `INSERT`, `UPDATE`, `DELETE`, sowie `DEFAULT`-Werte und `NOT NULL` Constraints.

???+ info "Übungsvorbereitung"

    Stelle sicher, dass du zur TecGuy GmbH Datenbank verbunden bist:

    ```sql
    -- Zur Datenbank wechseln
    \c produktionsplanung_db
    ```

???+ question "Aufgabe 1: Tabelle mit DEFAULT und NOT NULL erstellen"

    Erstelle die Maschinen-Tabelle mit **DEFAULT-Werten und NOT NULL Constraints**:

    Erstelle die Tabelle `maschinen` mit folgenden Eigenschaften:

    - `maschinen_id` (INTEGER, PRIMARY KEY)
    - `maschinenname` (VARCHAR(100), **NOT NULL** - muss immer angegeben werden)
    - `maschinentyp` (VARCHAR(50), **NOT NULL** - muss immer angegeben werden)
    - `produktionshalle` (VARCHAR(50), **NOT NULL**, DEFAULT `'Halle Zentral'`)
    - `anschaffungsjahr` (INTEGER, **NOT NULL**, DEFAULT `2024`)
    - `maschinenstatus` (VARCHAR(20), **NOT NULL**, DEFAULT `'Aktiv'`)
    - `wartungsintervall_tage` (INTEGER, DEFAULT `90` - kann NULL sein)

    ??? tip "Lösung anzeigen"

        ```sql
        CREATE TABLE maschinen (
            maschinen_id INTEGER PRIMARY KEY,
            maschinenname VARCHAR(100) NOT NULL,
            maschinentyp VARCHAR(50) NOT NULL,
            produktionshalle VARCHAR(50) NOT NULL DEFAULT 'Halle Zentral',
            anschaffungsjahr INTEGER NOT NULL DEFAULT 2024,
            maschinenstatus VARCHAR(20) NOT NULL DEFAULT 'Aktiv',
            wartungsintervall_tage INTEGER DEFAULT 90
        );
        ```

        **Wichtige Konzepte:**

        - **NOT NULL ohne DEFAULT** (`maschinenname`, `maschinentyp`) → **muss** beim INSERT angegeben werden
        - **NOT NULL mit DEFAULT** (`produktionshalle`, `anschaffungsjahr`, `maschinenstatus`) → kann weggelassen werden (bekommt DEFAULT), aber **nicht** explizit NULL
        - **Nur DEFAULT ohne NOT NULL** (`wartungsintervall_tage`) → kann weggelassen werden (bekommt DEFAULT) **oder** explizit NULL

???+ question "Aufgabe 2: INSERT - Maschinen einfügen und DEFAULT/NOT NULL testen"

    Füge Maschinen ein und **teste das Verhalten** von DEFAULT und NOT NULL:

    1. Füge **CNC-Fraese Alpha** (ID: 1) ein:
       - Name: `'CNC-Fraese Alpha'`
       - Typ: `'CNC-Fraese'`
       - **Nur diese beiden Spalten angeben** → Rest soll DEFAULT-Werte bekommen

    2. Füge **Drehbank Beta** (ID: 2) ein:
       - Name: `'Drehbank Beta'`
       - Typ: `'Drehbank'`
       - Halle: `'Halle Nord'` (DEFAULT überschreiben)

    3. Füge **Schweissroboter Gamma** (ID: 3) ein:
       - Name: `'Schweissroboter Gamma'`
       - Typ: `'Schweissroboter'`
       - Halle: `'Halle Sued'`
       - Anschaffungsjahr: `2020`
       - Status: `'Wartung'`
       - Wartungsintervall: `60` Tage

    4. Füge **Lackieranlage Delta** (ID: 4) ein:
       - Name: `'Lackieranlage Delta'`
       - Typ: `'Lackieranlage'`
       - Wartungsintervall: **NULL** (explizit)

    5. **Teste**, was passiert, wenn du versuchst eine Maschine **ohne** `maschinentyp` einzufügen (sollte fehlschlagen!):
       ```sql
       INSERT INTO maschinen (maschinen_id, maschinenname)
       VALUES (99, 'Fehlertest');
       ```

    6. Zeige alle Maschinen mit `SELECT * FROM maschinen;` an.

    ??? tip "Lösung anzeigen"

        ```sql
        -- 1. CNC-Fraese Alpha - nur Pflichtfelder, Rest DEFAULT
        INSERT INTO maschinen (maschinen_id, maschinenname, maschinentyp)
        VALUES (1, 'CNC-Fraese Alpha', 'CNC-Fraese');
        -- Ergebnis: produktionshalle='Halle Zentral', anschaffungsjahr=2024,
        --           maschinenstatus='Aktiv', wartungsintervall_tage=90

        -- 2. Drehbank Beta - DEFAULT teilweise überschreiben
        INSERT INTO maschinen (maschinen_id, maschinenname, maschinentyp, produktionshalle)
        VALUES (2, 'Drehbank Beta', 'Drehbank', 'Halle Nord');

        -- 3. Schweissroboter Gamma - alle Werte explizit
        INSERT INTO maschinen (maschinen_id, maschinenname, maschinentyp, produktionshalle, anschaffungsjahr, maschinenstatus, wartungsintervall_tage)
        VALUES (3, 'Schweissroboter Gamma', 'Schweissroboter', 'Halle Sued', 2020, 'Wartung', 60);

        -- 4. Lackieranlage Delta - wartungsintervall_tage auf NULL
        INSERT INTO maschinen (maschinen_id, maschinenname, maschinentyp, wartungsintervall_tage)
        VALUES (4, 'Lackieranlage Delta', 'Lackieranlage', NULL);
        -- wartungsintervall_tage=NULL (funktioniert, da kein NOT NULL!)

        -- 5. Fehlertest - sollte fehlschlagen
        INSERT INTO maschinen (maschinen_id, maschinenname)
        VALUES (99, 'Fehlertest');
        -- ❌ FEHLER: NULL value in column "maschinentyp" violates not-null constraint

        -- 6. Alle Maschinen anzeigen
        SELECT * FROM maschinen ORDER BY maschinen_id;
        ```

???+ question "Aufgabe 3: UPDATE - Daten aktualisieren"

    In der TecGuy GmbH haben sich Änderungen ergeben:

    1. **CNC-Fraese Alpha** (ID 1) geht in Wartung. Ändere den Status auf `'Wartung'`.

    2. **Drehbank Beta** (ID 2) wird verlegt. Ändere die Halle auf `'Halle West'` **und** das Wartungsintervall auf `120` Tage (beide in einem UPDATE).

    3. **Schweissroboter Gamma** (ID 3) ist fertig gewartet. Setze den Status zurück auf `'Aktiv'`.

    4. Alle Maschinen **ohne** Wartungsintervall (`wartungsintervall_tage IS NULL`) sollen das Standard-Wartungsintervall von `90` Tagen bekommen.

    **Wichtig:** Prüfe immer erst mit `SELECT`, bevor du `UPDATE` ausführst!

    ??? tip "Lösung anzeigen"

        ```sql
        -- 1. CNC-Fraese Alpha in Wartung setzen
        SELECT * FROM maschinen WHERE maschinen_id = 1;  -- Safety check
        UPDATE maschinen
        SET maschinenstatus = 'Wartung'
        WHERE maschinen_id = 1;

        -- 2. Drehbank Beta: Halle und Wartungsintervall ändern
        SELECT * FROM maschinen WHERE maschinen_id = 2;  -- Safety check
        UPDATE maschinen
        SET produktionshalle = 'Halle West',
            wartungsintervall_tage = 120
        WHERE maschinen_id = 2;

        -- 3. Schweissroboter Gamma auf Aktiv setzen
        SELECT * FROM maschinen WHERE maschinen_id = 3;  -- Safety check
        UPDATE maschinen
        SET maschinenstatus = 'Aktiv'
        WHERE maschinen_id = 3;

        -- 4. Allen Maschinen ohne Wartungsintervall 90 Tage geben
        SELECT * FROM maschinen WHERE wartungsintervall_tage IS NULL;  -- Safety check
        UPDATE maschinen
        SET wartungsintervall_tage = 90
        WHERE wartungsintervall_tage IS NULL;

        -- Ergebnis prüfen
        SELECT * FROM maschinen ORDER BY maschinen_id;
        ```

???+ question "Aufgabe 4: UPDATE mit Berechnungen und String-Operationen"

    Erweiterte UPDATE-Operationen:

    1. **Alle** Maschinen aus dem Jahr 2024 (DEFAULT-Wert!) wurden tatsächlich 2023 angeschafft. Korrigiere das Anschaffungsjahr indem du **1 Jahr abziehst**.

    2. Das Wartungsintervall für alle Maschinen vom Typ `'CNC-Fraese'` soll um **30 Tage verlängert** werden (aktueller Wert + 30).

    3. Alle Produktionshallen sollen umbenannt werden: Ersetze `"Halle"` durch `"Produktionshalle"`.

    4. Alle Maschinennamen in Hallen die "Nord" enthalten sollen das Präfix `"Nord-"` bekommen.

    **Tipp:** Nutze Berechnungen (`+`, `-`) und String-Funktionen (`REPLACE`, `CONCAT`).

    ??? tip "Lösung anzeigen"

        ```sql
        -- 1. Anschaffungsjahr korrigieren (2024 → 2023)
        SELECT * FROM maschinen WHERE anschaffungsjahr = 2024;  -- Safety check
        UPDATE maschinen
        SET anschaffungsjahr = anschaffungsjahr - 1
        WHERE anschaffungsjahr = 2024;

        -- 2. Wartungsintervall für CNC-Fraesen verlängern
        SELECT * FROM maschinen WHERE maschinentyp = 'CNC-Fraese';  -- Safety check
        UPDATE maschinen
        SET wartungsintervall_tage = wartungsintervall_tage + 30
        WHERE maschinentyp = 'CNC-Fraese';

        -- 3. Produktionshallen umbenennen
        UPDATE maschinen
        SET produktionshalle = REPLACE(produktionshalle, 'Halle', 'Produktionshalle');

        -- 4. Präfix für Maschinen in Nord-Hallen
        SELECT * FROM maschinen WHERE produktionshalle LIKE '%Nord%';  -- Safety check
        UPDATE maschinen
        SET maschinenname = CONCAT('Nord-', maschinenname)
        WHERE produktionshalle LIKE '%Nord%';

        -- Ergebnis prüfen
        SELECT * FROM maschinen ORDER BY maschinen_id;
        ```

???+ question "Aufgabe 5: DELETE - Maschinen löschen"

    Die TecGuy GmbH muss einige Maschinen ausmustern:

    1. Die **Lackieranlage Delta** (ID 4) wird verschrottet. Lösche sie aus der Datenbank.

    2. Füge zuerst zwei Testmaschinen ein:
       ```sql
       INSERT INTO maschinen (maschinen_id, maschinenname, maschinentyp)
       VALUES (98, 'Testmaschine 1', 'Test');

       INSERT INTO maschinen (maschinen_id, maschinenname, maschinentyp)
       VALUES (99, 'Testmaschine 2', 'Test');
       ```
       Lösche dann **alle** Maschinen aus dem Jahr 2023 (das ist der korrigierte DEFAULT-Wert aus Aufgabe 4!).

    3. **Sicherheitscheck:** Was würde `DELETE FROM maschinen;` ohne WHERE bewirken? (NICHT AUSFÜHREN!)

    **Goldene Regel:** Immer erst `SELECT` mit der gleichen WHERE-Bedingung, dann `DELETE`!

    ??? tip "Lösung anzeigen"

        ```sql
        -- 1. Lackieranlage Delta löschen
        SELECT * FROM maschinen WHERE maschinen_id = 4;  -- Safety check
        DELETE FROM maschinen WHERE maschinen_id = 4;

        -- 2. Testmaschinen einfügen
        INSERT INTO maschinen (maschinen_id, maschinenname, maschinentyp)
        VALUES (98, 'Testmaschine 1', 'Test');

        INSERT INTO maschinen (maschinen_id, maschinenname, maschinentyp)
        VALUES (99, 'Testmaschine 2', 'Test');

        -- Prüfen welche Maschinen aus 2023 sind
        SELECT * FROM maschinen WHERE anschaffungsjahr = 2023;  -- Safety check

        -- Alle Maschinen aus 2023 löschen
        DELETE FROM maschinen WHERE anschaffungsjahr = 2023;
        -- Löscht beide Testmaschinen (ID 98, 99) und andere aus 2023

        -- 3. Sicherheitscheck (NICHT AUSFÜHREN!)
        -- DELETE FROM maschinen; würde ALLE Maschinen löschen!
        -- NIEMALS ohne WHERE-Klausel verwenden!

        -- Verbleibende Maschinen anzeigen
        SELECT * FROM maschinen ORDER BY maschinen_id;
        ```

        **Wichtige Beobachtung:**

        Die Testmaschinen bekamen automatisch `anschaffungsjahr = 2024` (DEFAULT), welches in Aufgabe 4 auf 2023 korrigiert wurde. Daher werden sie mit dem DELETE erfasst!

---

